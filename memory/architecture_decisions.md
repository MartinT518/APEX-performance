# Architecture Decisions Log

| ID | Decision | Status | Context |
| :--- | :--- | :--- | :--- |
| ADR-001 | **Next.js (App Router) as Core Framework** | Accepted | We need a hybrid of static content (dashboards) and heavy client-side interactivity (Niggle Sliders, Agent Logic). Next.js offers the best PWA support and Server Actions for the "Monte Carlo" simulations. |
| ADR-002 | **Zustand for State Management** | Accepted | The "Micro-Agents" (Structural, Metabolic, Fueling) require complex, cross-component state access without prop drilling. Zustand is lightweight and handles transient updates (sliders) better than Context. |
| ADR-003 | **Supabase for Backend/Auth** | Accepted | We need rapid schema iteration for "Phenotype Configs" and "Session Logs". Supabase provides built-in Auth and a Postgres DB that fits our relational data needs (Users -> Sessions -> Votes). |
| ADR-004 | **Tailwind CSS for Styling** | Accepted | "Minimalist, Dark Mode default" vibe requires a utility-first approach for rapid UI development and consistent design tokens. |
| ADR-005 | **Client-Side Agent Logic (Modules M, E)** | Accepted | The "Daily Micro-Engine" (Agents A, B, C) must run instantly. We will implement these as pure TS functions running in the browser to enable immediate "Veto" feedback without network latency. |
| ADR-006 | **Server-Side Simulation (Module R)** | Accepted | The "Macro-Engine" (Monte Carlo Sim) is computationally expensive. This will run as a Server Action (Node.js) to offload the client and ensure consistent probabilistic modeling. |
| ADR-007 | **Hybrid Data Ingestion (Module K)** | Accepted | **Garmin MCP Webhooks** will be received by Supabase Edge Functions. **FIT File Parsing** will occur Server-Side (Node.js) to ensure robust "High-Rev Filtering" before data ever reaches the Client Agents. |
| ADR-008 | **Strict Module Separation** | Accepted | The codebase will strictly mirror the FRD structure: `src/modules/monitor`, `src/modules/kill`, `src/modules/execute`, `src/modules/review`. This ensures every FR has a dedicated home. |
| ADR-009 | **Phenotype "Truth" File Storage** | Accepted | The `Phenotype_Config` (FR-M1) will be stored in Supabase (Postgres) but cached locally (Zustand/LocalStorage) to allow offline "Chassis Checks" and immediate Agent initialization. |
| ADR-010 | **Python MCP for Raw FIT Parsing** | Accepted | To detect "Cadence Lock" (FR-K2), we need raw byte stream access which JS libraries struggle with. We implement a **Python FastMCP server** using `fitparse` to download and process `.FIT` files before passing clean JSON to the Next.js app. |
| ADR-011 | **Recharts for Data Visualization** | Accepted | For the web dashboard, we use **Recharts** (over Victory Native) as it integrates seamlessly with React/Next.js and allows highly customizable, responsive components like the "Chassis Integrity Gauge" and "Tonnage Candlestick". |
| ADR-012 | **MAKER Process Workflow** | Adopted | We enforce a strict **Decomposition -> Test (Red Flag) -> Implement -> Verify** loop. This "Measure Twice, Cut Once" approach prevents architectural drift and ensures every feature is verified against a strict failure condition before coding. |
| ADR-013 | **Atomic Module Decomposition** | Adopted | All store and orchestration files must be decomposed into `logic/` subdirectories when exceeding 100 lines. Each module follows single responsibility: `profileLoader.ts`, `profileUpdater.ts`, `persistence.ts`, etc. This ensures maintainability and testability. |
| ADR-014 | **Strict TypeScript Type Safety** | Enforced | Zero tolerance for `any` types. External APIs (e.g., Garmin) require proper TypeScript interfaces in `src/types/`. Error handling uses `unknown` with type guards. All function parameters must be explicitly typed. |
| ADR-015 | **Component Extraction Pattern** | Adopted | Large page components (>200 lines) are decomposed into smaller, reusable components in `components/` directory. Examples: `DashboardHeader`, `AlertBanner`, `AnalysisResultCard`, `AgentStatusGrid`. Each component handles a single UI concern. |
